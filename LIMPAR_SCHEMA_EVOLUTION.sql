-- ============================================================================
-- LIMPAR SCHEMA EVOLUTION - Preparar para v2.0.10
-- ============================================================================
--
-- OBJETIVO: Remover todas as tabelas e ENUMs da v2.2.3 (latest)
--           para permitir que v2.0.10 crie schema limpo
--
-- SEGURANรA: Sรณ afeta schema 'evolution' (Evolution API)
--            Schema 'public' (AgendaOnSell) permanece 100% INTACTO
--
-- ============================================================================

\echo ''
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo '๐ LIMPANDO SCHEMA EVOLUTION'
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''
\echo 'Este script vai DELETAR o schema evolution e recriรก-lo vazio.'
\echo ''
\echo 'โ๏ธ  ATENรรO:'
\echo '   โข Schema EVOLUTION (Evolution API) serรก ZERADO'
\echo '   โข Schema PUBLIC (AgendaOnSell) NรO serรก afetado'
\echo ''
\echo 'Isso รฉ necessรกrio para fazer downgrade de v2.2.3 โ v2.0.10'
\echo ''
\echo 'Aguarde 5 segundos (Ctrl+C para cancelar)...'
\echo ''

SELECT pg_sleep(5);

-- ============================================================================
-- PASSO 1: Listar tabelas que serรฃo deletadas
-- ============================================================================

\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo '๐ TABELAS QUE SERรO DELETADAS'
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''

SELECT tablename
FROM pg_tables
WHERE schemaname = 'evolution'
ORDER BY tablename;

\echo ''
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo 'โ๏ธ  รLTIMA CHANCE PARA CANCELAR!'
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''
\echo 'Todas as tabelas acima serรฃo DELETADAS!'
\echo ''
\echo 'Aguarde 5 segundos (Ctrl+C para cancelar)...'
\echo ''

SELECT pg_sleep(5);

-- ============================================================================
-- PASSO 2: Dropar schema evolution CASCADE
-- ============================================================================

\echo ''
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo '๐๏ธ  DELETANDO SCHEMA EVOLUTION'
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''

DROP SCHEMA IF EXISTS evolution CASCADE;

\echo 'โ Schema evolution deletado!'
\echo ''

-- ============================================================================
-- PASSO 3: Recriar schema evolution vazio
-- ============================================================================

\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo '๐จ RECRIANDO SCHEMA EVOLUTION (vazio)'
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''

CREATE SCHEMA evolution;

\echo 'โ Schema evolution criado (vazio)'
\echo ''

-- ============================================================================
-- PASSO 4: Restaurar permissรตes
-- ============================================================================

\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo '๐ RESTAURANDO PERMISSรES'
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''

GRANT ALL ON SCHEMA evolution TO sasconv_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA evolution GRANT ALL ON TABLES TO sasconv_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA evolution GRANT ALL ON SEQUENCES TO sasconv_user;

\echo 'โ Permissรตes restauradas'
\echo ''

-- ============================================================================
-- PASSO 5: Verificar resultado
-- ============================================================================

\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo '๐ VERIFICANDO RESULTADO'
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''

\echo '๐ Tabelas no schema evolution:'
SELECT COUNT(*) as total_tabelas
FROM pg_tables
WHERE schemaname = 'evolution';

\echo ''
\echo 'โ Esperado: 0 tabelas (schema vazio)'
\echo ''

\echo '๐ Tabelas no schema public (AgendaOnSell):'
SELECT COUNT(*) as total_tabelas
FROM pg_tables
WHERE schemaname = 'public';

\echo ''
\echo 'โ Esperado: 13 tabelas (AgendaOnSell intacto)'
\echo ''

-- ============================================================================
-- RESUMO FINAL
-- ============================================================================

\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo 'โ LIMPEZA CONCLUรDA COM SUCESSO!'
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''
\echo 'โ Schema evolution: VAZIO (pronto para v2.0.10)'
\echo 'โ Schema public: INTACTO (AgendaOnSell preservado)'
\echo ''
\echo '๐ PRรXIMOS PASSOS:'
\echo ''
\echo '   1. No Render Dashboard:'
\echo '      โข Evolution API โ Manual Deploy โ Deploy latest commit'
\echo ''
\echo '   2. A v2.0.10 vai criar automaticamente:'
\echo '      โข 8-10 tabelas (versรฃo estรกvel)'
\echo '      โข Sem ENUMs problemรกticos'
\echo '      โข Schema limpo e funcional'
\echo ''
\echo '   3. Logs esperados:'
\echo '      [Evolution API]    v2.0.10  ...'
\echo '      Prisma schema loaded from prisma/postgresql-schema.prisma'
\echo '      ๐  Your database is now in sync with your Prisma schema.'
\echo '      Server started on port 8080  โ'
\echo ''
\echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
\echo ''
